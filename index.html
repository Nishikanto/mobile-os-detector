@(title: String, reviewId: String)

<!DOCTYPE html>
<html>
    <head>
        <title>@title</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body {
                font-family: 'Arial', sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }

            .container {
                text-align: center;
            }

            .logo {
                width: 180px;
                margin-bottom: 20px;
            }

        </style>
            <!-- Bowser UA parser -->
        <script src="https://unpkg.com/bowser@@2.11.0/es5.js"></script>

        <script>
                window.onload = function () {
                    const BASE_URL = "https://staging.shipday.com";
                    const reviewId = "@reviewId";
                    const DEFAULT_FALLBACK_URL = `${BASE_URL}/dashboard?reviewId=${reviewId}#reviews`;

                    function detect() {
                        const parser = bowser.getParser(navigator.userAgent || "");
                        const osName = (parser.getOSName(true) || "").toLowerCase();
                        const platformType = (parser.getPlatformType(true) || "").toLowerCase();
                        const touch = ("ontouchstart" in window) || (navigator.maxTouchPoints || 0) > 0;
                        const isAndroid = osName === "android";
                        const isIOS = osName === "ios" || (osName === "macos" && (navigator.maxTouchPoints || 0) > 1);
                        const isMobile = (platformType === "mobile" || platformType === "tablet" ||
                                Math.min(window.innerWidth, window.innerHeight) <= 1024) && touch;
                        return { isAndroid, isIOS, isMobile };
                    }

                    const { isAndroid, isIOS, isMobile } = detect();

                    if (!isMobile) {
                        window.location.href = DEFAULT_FALLBACK_URL;
                        return;
                    }

                    let appOpened = false;
                    let hiddenAt = 0;
                    let safeFallbackFired = false;

                    function markOpened() {
                        appOpened = true;
                        clearAllFallbackTimers();
                    }

                    function onVisibilityChange() {
                        if (document.hidden) {
                            hiddenAt = Date.now();
                        } else {
                            const delta = hiddenAt ? (Date.now() - hiddenAt) : 0;
                            if (delta >= 300 && delta <= 60000) markOpened();
                        }
                    }

                    function onPageHide() { markOpened(); }

                    document.addEventListener("visibilitychange", onVisibilityChange);
                    window.addEventListener("pagehide", onPageHide);

                    function fallbackToDashboard() {
                        if (safeFallbackFired || appOpened) return;
                        safeFallbackFired = true;
                        window.location.href = DEFAULT_FALLBACK_URL;
                    }

                    const timers = [];
                    function setT(fn, ms) { const id = setTimeout(fn, ms); timers.push(id); return id; }
                    function clearAllFallbackTimers() { while (timers.length) clearTimeout(timers.pop()); }

                    // setT(() => { if (!appOpened) fallbackToDashboard(); }, 3500);
                    // setT(() => { if (!appOpened) fallbackToDashboard(); }, 6000);

                    const IOS_PRIMARY     = `shipday://review/${reviewId}`;
                    const IOS_ALTERNATE   = `shipday://dispatch.shipday.com/review/${reviewId}`;
                    const ANDROID_PRIMARY = `shipday://dispatch.shipday.com/review/${reviewId}`;
                    const ANDROID_ALTERNATE = `shipday://review/${reviewId}`;

                    if (isAndroid) {
                        window.location.href = ANDROID_PRIMARY;
                        setT(() => { if (!appOpened) window.location.href = ANDROID_ALTERNATE; }, 800);
                        setT(() => { if (!appOpened) fallbackToDashboard(); }, 2500);
                    } else if (isIOS) {
                        window.location.href = IOS_PRIMARY;
                        setT(() => { if (!appOpened) window.location.href = IOS_ALTERNATE; }, 800);
                        setT(() => { if (!appOpened) fallbackToDashboard(); }, 2500);
                    } else {
                        fallbackToDashboard();
                    }
                };
        </script>

    </head>
    <body>
        <div class="container">
            <img src="/assets/images/logo-shipday-solid.svg" alt="Shipday Logo" class="logo">
            <div>Please wait, loading the dispatch dashboard...</div>
        </div>
    </body>
</html>
